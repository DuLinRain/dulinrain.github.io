<!DOCTYPE html>
<html>
<head>
<title>æ·±å…¥ç†è§£HMRå®ç°åŸç†</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}
html::after {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 100px;
    content: url(http://www.dulinrain.top/zhifu.png);
}
html, body {
    font-family: Roboto, sans-serif;
    -webkit-font-smoothing: antialiased;
    font-smoothing: antialiased;
}
h1:first-child {
 	border-bottom: 1px solid gray;
    padding: 20px;
    position: relative;
    text-align: center;
}
h1:first-child:after {
	content: 'by DuLinRain';
    display: block;
    position: absolute;
    right: 0px;
    top: calc(100% - 20px);
    font-size: 14px;
    font-weight: normal;
    font-family: sans-serif;
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.pl-c {
    color: #969896;
}

.pl-c1,.pl-mdh,.pl-mm,.pl-mp,.pl-mr,.pl-s1 .pl-v,.pl-s3,.pl-sc,.pl-sv {
    color: #0086b3;
}

.pl-e,.pl-en {
    color: #795da3;
}

.pl-s1 .pl-s2,.pl-smi,.pl-smp,.pl-stj,.pl-vo,.pl-vpf {
    color: #333;
}

.pl-ent {
    color: #63a35c;
}

.pl-k,.pl-s,.pl-st {
    color: #a71d5d;
}

.pl-pds,.pl-s1,.pl-s1 .pl-pse .pl-s2,.pl-sr,.pl-sr .pl-cce,.pl-sr .pl-sra,.pl-sr .pl-sre,.pl-src,.pl-v {
    color: #df5000;
}

.pl-id {
    color: #b52a1d;
}

.pl-ii {
    background-color: #b52a1d;
    color: #f8f8f8;
}

.pl-sr .pl-cce {
    color: #63a35c;
    font-weight: bold;
}

.pl-ml {
    color: #693a17;
}

.pl-mh,.pl-mh .pl-en,.pl-ms {
    color: #1d3e81;
    font-weight: bold;
}

.pl-mq {
    color: #008080;
}

.pl-mi {
    color: #333;
    font-style: italic;
}

.pl-mb {
    color: #333;
    font-weight: bold;
}

.pl-md,.pl-mdhf {
    background-color: #ffecec;
    color: #bd2c00;
}

.pl-mdht,.pl-mi1 {
    background-color: #eaffea;
    color: #55a532;
}

.pl-mdr {
    color: #795da3;
    font-weight: bold;
}

.pl-mo {
    color: #1d3e81;
}
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>
<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
</head>
<body>
<h1 id="-hmr-">æ·±å…¥ç†è§£HMRå®ç°åŸç†</h1>
<h3 id="-hmr-">ä¸€. ä»€ä¹ˆæ˜¯HMR?</h3>
<p>HMRï¼Œåˆç§°æ¨¡å—çƒ­æ›¿æ¢ï¼Œæ˜¯å¯¹äºæˆ‘ä»¬é«˜æ•ˆåœ°è¿›è¡Œå‰ç«¯å¼€å‘éå¸¸æœ‰å¸®åŠ©ï¼Œçƒ­æ¨¡å—æ›¿æ¢æ˜¯ä¸€ç§WebpackåŠŸèƒ½ï¼Œå¯åœ¨ä¸é‡æ–°åŠ è½½æµè§ˆå™¨çš„æƒ…å†µä¸‹æ›´æ–°æ‚¨çš„Javascriptã€‚ çƒ­æ¨¡å—æ›¿æ¢ä¸­çš„â€œæ¨¡å—â€ä»…æŒ‡æ‚¨çš„æ¯ä¸ªJavascriptæºä»£ç æ–‡ä»¶ã€‚ å›é¡¾ä¸€ä¸‹ï¼Œåœ¨æ²¡æœ‰å„ç§æ„å»ºå·¥å…·ä¹‹å‰ï¼Œæˆ‘ä»¬æœ€åŸå§‹çš„å¼€æ‰‹åŠ¨ï¼Œç„¶åç”¨webpack -wï¼Œå†åæ¥æœ‰äº†HMRã€‚</p>
<h3 id="-hmr-">äºŒ. HMRçš„å®ç°åŸç†</h3>
<p>å½“å¯ç”¨HMRåï¼Œwebpackåœ¨ä½ çš„è¾“å‡ºbundleä¸­æ’å…¥äº†ä¸€æ®µå«åš<strong>HMR Runtime</strong>çš„ä»£ç ï¼Œå½“ä½ çš„bundleåœ¨æµè§ˆå™¨ä¸­åŠ è½½åï¼Œè¿™æ®µä»£ç ä¹Ÿä¼šè¿è¡Œï¼Œå®ƒè´Ÿè´£æ¥æ”¶webpackçš„é€šçŸ¥å¹¶ä¸”æ‹‰å–æ›´æ–°ã€‚</p>
<p>å½“ç„¶ï¼Œåªæœ‰å®¢æˆ·ç«¯çš„ä»£ç æ˜¯ä¸å¤Ÿçš„ï¼Œwebpackè‡ªç”Ÿä¼šè¿è¡Œä¸€ä¸ªå«åš<strong>HMR Server</strong>çš„ä»£ç , ç”¨äºé€šçŸ¥<strong>HMR Runtime</strong>ä½•æ—¶å»æ›´æ–°ä»£ç ï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£å°†æ–°çš„ä»£ç ä»¥jsonçš„å½¢å¼å‘é€ç»™<strong>HMR Runtime</strong>ã€‚</p>
<p><strong>HMR Server</strong>ã€<strong>HMR Runtime</strong>ã€æœ¬åœ°æºæ–‡ä»¶ã€webpackä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨å¦‚ä¸‹å›¾æ¥è¡¨è¿°ï¼š</p>
<p><img src="https://i.imgur.com/DbyoFOD.png" alt=""></p>
<p>è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™äº›åè¯ï¼š</p>
<p><strong>webpack compiler:</strong> ç¼–è¯‘å™¨æ˜¯webpackçš„æ ¸å¿ƒè´Ÿè´£å°†æºä»£ç æ‰“åŒ…æˆbundle.jsè¾“å‡ºã€‚<br><strong>HMR serverï¼š</strong>è´Ÿè´£é€šçŸ¥å¹¶å‘é€çƒ­æ¨¡å—ç»™HMR Runtime<br><strong>Bundle Server:</strong> è´Ÿè´£ç»™æµè§ˆå™¨æä¾›bundle.js<br><strong>bundle.jsï¼š</strong>webpack compilerç¼–è¯‘å‡ºçš„jsï¼Œä¼šä»¥scriptçš„æ ‡ç­¾æ’å…¥é¡µé¢<br><strong>HMR runtimeï¼š</strong> è¿™æ®µä»£ç è¢«æ³¨å…¥åˆ°bundle.jsä¸­ï¼Œä»–ä¼šé¢„HMR Serveré€šä¿¡å¹¶æ›´æ–°æ¨¡å—</p>
<p>å¯åŠ¨æµç¨‹</p>
<p>å½“ä½ ç¬¬ä¸€æ¬¡å¯åŠ¨HMR(ä½¿ç”¨webpack-dev-server æˆ– webpack-hot-middleware))çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸€ä¸ªåˆå§‹çš„bundle.jsã€‚å…¶å®ä¸è®ºä½ ç”¨æ²¡ç”¨åˆ°HMRï¼Œéƒ½ä¼šæœ‰å‰è¿°è¿™ä¸ªè¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯ï¼š</p>
<p>Aï¼š Webpack Compiler ç¼–è¯‘ JS ä»£ç .<br>Bï¼š Bundle Server æ‰“åŒ…bundleç»™æµè§ˆå™¨åŠ è½½ä½¿ç”¨ã€‚</p>
<p>ä½¿ç”¨HMRåï¼Œä¼šæœ‰ä¸€ä¸ªæ›´æ–°æµç¨‹ã€‚</p>
<p>æ›´æ–°æµç¨‹</p>
<p>æ›´æ–°æµç¨‹æ¶‰åŠåˆ°å¥½å‡ æ­¥ï¼š</p>
<p>1ã€ä½ æ”¹å˜ä½ çš„æºä»£ç å¹¶ä¿å­˜ã€‚<br>2ã€æ–‡æœ¬ç¼–è¾‘å™¨æ£€æŸ¥åˆ°æ›´æ–°ï¼Œé€šçŸ¥webpackã€‚<br>3ã€webpack compileré‡æ–°æ„å»ºä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—ï¼Œå¹¶é€šçŸ¥HMR Serveræœ‰æ–°çš„æ¨¡å—æ›´æ–°ã€‚<br>4ã€HMR Serveré€šè¿‡websocketæˆ–å…¶å®ƒæ–¹å¼é€šçŸ¥HMR Runtimeå®ƒéœ€è¦æ›´æ–°ï¼ŒHMR Runtimeé€šè¿‡HTTPå‘HMR Serverè¯·æ±‚æ›´æ–°çš„æ¨¡å—ã€‚<br>5ã€HMR Runtimeç”¨æ”¶åˆ°çš„æ–°æ¨¡å—æ›¿æ¢æ—§æ¨¡å—ï¼Œå¦‚æœå®ƒæ²¡æ³•æ›¿æ¢çš„è¯ä¼šç›´æ¥æ•´ä¸ªåˆ·æ–°æµè§ˆå™¨ã€‚</p>
<p>æ¨¡å—çƒ­æ›¿æ¢ä¸ä¼šè§£é™¤æ—§æ¨¡å—ä»£ç ä¸­çš„å‰¯ä½œç”¨ï¼Œå¦‚æœä½ çš„æ—§æ¨¡å—æœ‰å‰¯ä½œç”¨ï¼Œä½ éœ€è¦æ‰‹åŠ¨çš„è°ƒç”¨module.hot.dispose()å»è§£é™¤ã€‚æ¯”å¦‚setIntervalä¹‹ç±»çš„å‰¯ä½œç”¨ã€‚</p>
<h3 id="-hmr-">ä¸‰. å¦‚ä½•é…ç½®HMRï¼Ÿ</h3>
<p>é…ç½®HMRæœ€å¸¸è§çš„æœ‰2ç§æ–¹æ³•ï¼š</p>
<ol>
<li>ä½¿ç”¨webpack-dev-serveré…ç½®</li><li>ä½¿ç”¨webpack-dev-middlewareå’Œwebpack-hot-middlewareé…ç½®</li></ol>
<p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†åˆ«çœ‹çœ‹è¿™ä¸¤ç§é…ç½®æ–¹æ³•ï¼›</p>
<h4 id="3-1-webpack-dev-server-">3.1 ä½¿ç”¨webpack-dev-serveré…ç½®</h4>
<p>ä½¿ç”¨webpack-dev-serveré…ç½®æ˜¯æœ€ç®€å•çš„é…ç½®æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯webpackå®˜æ–¹æ¨èçš„æ–¹å¼ã€‚å®ƒçš„é…ç½®åªéœ€è¦å‡ æ­¥ï¼š</p>
<h5 id="3-1-1-webpack-dev-server">3.1.1ã€ å®‰è£…webpack-dev-server</h5>
<pre><code>npm install webpack-dev-server --save-dev
</code></pre><blockquote>
<p>æ³¨æ„ï¼šå°½ç®¡ä½ ä¹Ÿå¯ä»¥å…¨å±€å®‰è£…ï¼Œä½†å®˜æ–¹å»ºè®®è¿˜æ˜¯æœ¬åœ°å®‰è£…ï¼Œå®ƒä¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°å®‰è£…</p>
</blockquote>
<h5 id="3-1-2-package-json-">3.1.2ã€ ä¿®æ”¹package.jsonï¼Œå¢åŠ å¯åŠ¨è„šæœ¬</h5>
<pre><code>&quot;scripts&quot;: {
    &quot;dev&quot;: &quot;webpack-dev-server&quot;,
 }
</code></pre><h5 id="3-1-3-webpack-config-js-">3.1.3ã€ åœ¨webpack.config.jsä¸­é…ç½®æ’ä»¶</h5>
<p>webpack.config.js</p>
<pre><code>const path = require(&#39;path&#39;);
const webpack = require(&#39;webpack&#39;);
module.exports = {
  entry: &#39;./src/index.js&#39;,
  plugins: [
    new webpack.NamedModulesPlugin(),
    new webpack.HotModuleReplacementPlugin()
  ],
  mode: &#39;development&#39;,
  output: {
    filename: &#39;bundle.js&#39;,
    path: path.resolve(__dirname, &#39;dist&#39;)
  }
};
</code></pre><h5 id="3-1-4-">3.1.4ã€å¯åŠ¨</h5>
<pre><code>npm run dev
</code></pre><p>ä¸€èˆ¬ä½ ä¼šåœ¨nodeå‘½ä»¤è¡Œçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p>
<p><img src="https://i.imgur.com/KAeHuJf.png" alt=""></p>
<p>webpack-dev-serverç»™æˆ‘ä»¬åœ¨8080ç«¯å£å¯åŠ¨äº†æœåŠ¡ï¼ŒæœåŠ¡çš„ç›®å½•ç›¸å¯¹äºæ ¹ç›®å½•ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸€èˆ¬æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹æœ‰ä¸ªindex.htmlæ–‡ä»¶ï¼Œæ–‡ä»¶å¼•å…¥çš„è„šæœ¬ä¸æˆ‘ä»¬åœ¨webpack.config.jsä¸­é…ç½®çš„è¾“å‡ºè„šæœ¬åç›¸å¯¹åº”ï¼Œç„¶åæˆ‘ä»¬æ‰“å¼€å“åº”çš„ç«¯å£ï¼Œå°±å¯ä»¥çœ‹åˆ°ç›¸åº”çš„æ•ˆæœäº†ã€‚</p>
<p>index.html</p>
<pre><code>&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;èµ·æ­¥&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script src=&quot;bundle.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³å¯¹æœåŠ¡å™¨ç«¯å£ç­‰åšä¸€äº›è°ƒæ•´ï¼Œå¯¹æœåŠ¡ç›®å½•åšè°ƒæ•´ç­‰ç­‰ï¼Œä½ å¯ä»¥åœ¨webpackä¸­é…ç½®devServerå±æ€§ï¼š</p>
<pre><code>devServer: {
  contentBase: path.join(__dirname, &quot;dist&quot;),
  compress: true,
  port: 9000,
  hot: true
}
</code></pre><p>devServerå¯é…ç½®çš„é€‰é¡¹å¾ˆå¤šï¼Œæˆ‘ä»¬å°±ä¸ä¸€ä¸€èµ˜è¿°ï¼Œæƒ³äº†è§£çš„å¯ä»¥å‚è€ƒ<a href="https://webpack.docschina.org/configuration/dev-server/#devserver">è¿™é‡Œ</a>ã€‚</p>
<p><img src="https://i.imgur.com/y0atAB5.png" alt=""><img src="https://i.imgur.com/DQwa1Ms.png" alt=""></p>
<h4 id="3-2-webpack-dev-middleware-webpack-hot-middleware-">3.2 ä½¿ç”¨webpack-dev-middlewareå’Œwebpack-hot-middlewareé…ç½®</h4>
<p>ä½¿ç”¨webpack-dev-middlewareå’Œwebpack-hot-middlewareé…ç½®å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œåªä¸è¿‡æˆ‘ä»¬éœ€è¦è‡ªå·±å†™server.jsï¼Œç”¨æ¥å¯åŠ¨expressæœåŠ¡ã€‚ å®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<h5 id="3-2-1-webpack-dev-middleware-webpack-hot-middleware-express">3.2.1ã€ å®‰è£…webpack-dev-middlewareå’Œwebpack-hot-middlewareå’Œexpress</h5>
<pre><code>npm install webpack-dev-middleware webpack-hot-middleware express --save-dev
</code></pre><h5 id="3-2-2-webpack-config-js">3.2.2ã€ ä¿®æ”¹webpack.config.js</h5>
<pre><code>const path = require(&#39;path&#39;);
const webpack = require(&#39;webpack&#39;);
module.exports = {
  entry: [&#39;webpack-hot-middleware/client?noInfo=true&amp;reload=true&#39; , &#39;./src/index.js&#39;],
  plugins: [
    new webpack.NamedModulesPlugin(),
    new webpack.HotModuleReplacementPlugin()
  ],
  mode: &#39;development&#39;,
  output: {
    filename: &#39;bundle.js&#39;,
    path: __dirname,//path.resolve(__dirname, &#39;dist&#39;)
  }
};
</code></pre><blockquote>
<p>æ³¨æ„ï¼šå…¥å£ç‚¹åŠ ä¸Šäº†&#39;webpack-hot-middleware/client?noInfo=true&amp;reload=true&#39;ï¼Œæ˜¯ç”¨æ¥è®©æµè§ˆå™¨åŠ è½½æ›´æ–°ï¼Œå¦åˆ™webpackä¼šè‡ªåŠ¨ç¼–è¯‘ï¼Œä½†æµè§ˆå™¨ä¸ä¼šè‡ªåŠ¨åŠ è½½æ›´æ–°ã€‚</p>
</blockquote>
<h5 id="3-2-3-server-js-">3.2.3ã€ ç¼–å†™server.jsè„šæœ¬</h5>
<pre><code>const webpack = require(&#39;webpack&#39;);
const middleware = require(&#39;webpack-dev-middleware&#39;);
var webpackConfig = require(&#39;./webpack.config&#39;);
var compiler = webpack(webpackConfig);
const express = require(&#39;express&#39;);
const app = express();

app.use(middleware(compiler, {
  // webpack-dev-middleware options
}));
app.use(require(&quot;webpack-hot-middleware&quot;)(compiler));
app.get(&quot;/&quot;, function(req, res) {
    res.sendFile(__dirname + &#39;/index.html&#39;);
});
app.listen(3000, () =&gt; console.log(&#39;Example app listening on port 3000!&#39;))
</code></pre><h5 id="3-2-4-package-json-">3.2.4ã€ ä¿®æ”¹package.jsonå¯åŠ¨è„šæœ¬</h5>
<pre><code>&quot;scripts&quot;: {
    &quot;dev&quot;: &quot;node server.js&quot;,
 }
</code></pre><h3 id="-webpack-hot-middleware-hmr-">å››. webpack-hot-middlewareå®ç°çš„HMRæºç åˆ†æ</h3>
<h4 id="4-1-hmr-server-">4.1 HMR Serverçš„æºç è§£è¯»</h4>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬ç”¨expresså¯åŠ¨äº†ä¸€ä¸ªæœåŠ¡ï¼Œè°ƒç”¨webpack-dev-middlewareç›¸å½“äºå¯åŠ¨äº†ä¸€ä¸ªæ–¹æ¡†å›¾ä¸­çš„webpack dev serverï¼Œå®ƒä¼šè°ƒç”¨webpackçš„é…ç½®æ–‡ä»¶æ‰“åŒ…ï¼Œä¹Ÿå°±æ˜¯æ–¹æ¡†å›¾ä¸­çš„webpack compilerï¼Œè¿™ä¸ªæ‰“åŒ…æœåŠ¡ç”¨äºç”Ÿæˆbundle.jsï¼Œç›¸å½“äºæ˜¯ç¬¬äºŒèŠ‚å›¾ä¸­çš„ Bundle serverï¼Œè€Œä½¿ç”¨äº†webpack-hot-middlewareåï¼Œç›¸å½“äºåœ¨webpack compilerä¸­æ³¨å…¥äº†ä¸€ä¸ªHMR Serverã€‚</p>
<p>HMR Serveræ˜¯ç”±webpack-hot-middlewareä¸­çš„middleware.jsæ–‡ä»¶å®ç°çš„ï¼Œå®ƒçš„æºä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>module.exports = webpackHotMiddleware;

var helpers = require(&#39;./helpers&#39;);
var pathMatch = helpers.pathMatch;

function webpackHotMiddleware(compiler, opts) {
  opts = opts || {};
  opts.log = typeof opts.log == &#39;undefined&#39; ? console.log.bind(console) : opts.log;
  opts.path = opts.path || &#39;/__webpack_hmr&#39;;
  opts.heartbeat = opts.heartbeat || 10 * 1000;
  //å¼€å¯EventStreamå®ç°æœåŠ¡ç«¯äº‹ä»¶æ¨é€(SSE)çš„â€˜é•¿è¿æ¥â€™
  var eventStream = createEventStream(opts.heartbeat);
  var latestStats = null;
  //ç›‘å¬webpackç¼–è¯‘å®Œæˆå’Œç¼–è¯‘æ— æ•ˆäº‹ä»¶
  if (compiler.hooks) {
    compiler.hooks.invalid.tap(&quot;webpack-hot-middleware&quot;, onInvalid);
    compiler.hooks.done.tap(&quot;webpack-hot-middleware&quot;, onDone);
  } else {
    compiler.plugin(&quot;invalid&quot;, onInvalid);
    compiler.plugin(&quot;done&quot;, onDone);
  }
  function onInvalid() {
    latestStats = null;
    if (opts.log) opts.log(&quot;webpack building...&quot;);
    //ç¼–è¯‘æ— æ•ˆæ—¶å‘å®¢æˆ·ç«¯æ¨é€buildingäº‹ä»¶
    eventStream.publish({action: &quot;building&quot;}); 
  }
  function onDone(statsResult) {
    // Keep hold of latest stats so they can be propagated to new clients
    latestStats = statsResult;
    //ç¼–è¯‘å®Œæˆæ—¶å‘å®¢æˆ·ç«¯æ¨é€builtäº‹ä»¶ï¼Œä»¥åŠçŠ¶æ€ç»“æœ
    publishStats(&quot;built&quot;, latestStats, eventStream, opts.log);
  }
  var middleware = function(req, res, next) {
    if (!pathMatch(req.url, opts.path)) return next();
    eventStream.handler(req, res);
    //å‘é€åŒæ­¥äº‹ä»¶
    if (latestStats) {
      // Explicitly not passing in `log` fn as we don&#39;t want to log again on
      // the server
      publishStats(&quot;sync&quot;, latestStats, eventStream);
    }
  };
  middleware.publish = eventStream.publish;
  return middleware;
}
//åˆ›å»ºSSEçš„å‡½æ•°
function createEventStream(heartbeat) {
  var clientId = 0;
  var clients = {};
  function everyClient(fn) {
    Object.keys(clients).forEach(function(id) {
      fn(clients[id]);
    });
  }
    //æ¯éš”heartbeat(é»˜è®¤10s)å‘å®¢æˆ·ç«¯æ¨é€ğŸ’“
  setInterval(function heartbeatTick() {
    everyClient(function(client) {
      client.write(&quot;data: \uD83D\uDC93\n\n&quot;);
    });
  }, heartbeat).unref();
  return {
    handler: function(req, res) {
      var headers = {
        &#39;Access-Control-Allow-Origin&#39;: &#39;*&#39;,
        &#39;Content-Type&#39;: &#39;text/event-stream;charset=utf-8&#39;,
        &#39;Cache-Control&#39;: &#39;no-cache, no-transform&#39;,
        // While behind nginx, event stream should not be buffered:
        // http://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffering
        &#39;X-Accel-Buffering&#39;: &#39;no&#39;
      };

      var isHttp1 = !(parseInt(req.httpVersion) &gt;= 2);
      if (isHttp1) {
        req.socket.setKeepAlive(true);
        Object.assign(headers, {
          &#39;Connection&#39;: &#39;keep-alive&#39;,
        });
      }

      res.writeHead(200, headers);
      res.write(&#39;\n&#39;);
      var id = clientId++;
      clients[id] = res;
      req.on(&quot;close&quot;, function(){
        delete clients[id];
      });
    },
    publish: function(payload) {
      everyClient(function(client) {
        //å‘é€æ•°æ®
        client.write(&quot;data: &quot; + JSON.stringify(payload) + &quot;\n\n&quot;);
      });
    }
  };
}

function publishStats(action, statsResult, eventStream, log) {
  // For multi-compiler, stats will be an object with a &#39;children&#39; array of stats
    //è½¬æ¢ä¸ºJSON
  var bundles = extractBundles(statsResult.toJson({ errorDetails: false }));
  bundles.forEach(function(stats) {
    if (log) {
      log(&quot;webpack built &quot; + (stats.name ? stats.name + &quot; &quot; : &quot;&quot;) +
        stats.hash + &quot; in &quot; + stats.time + &quot;ms&quot;);
    }
    //å‘æ¯ä¸ªå®¢æˆ·ç«¯æ¨é€å˜æ›´æ¨¡å—
    eventStream.publish({
      name: stats.name,
      action: action,
      time: stats.time,
      hash: stats.hash,
      warnings: stats.warnings || [],
      errors: stats.errors || [],
      modules: buildModuleMap(stats.modules)
    });
  });
}
//æå–æ¨¡å—
function extractBundles(stats) {
  // Stats has modules, single bundle
  if (stats.modules) return [stats];

  // Stats has children, multiple bundles
  if (stats.children &amp;&amp; stats.children.length) return stats.children;

  // Not sure, assume single
  return [stats];
}

function buildModuleMap(modules) {
  var map = {};
  modules.forEach(function(module) {
    map[module.id] = module.name;
  });
  return map;
}
</code></pre><p>ä»ä»¥ä¸Šæºä»£ç å¯ä»¥çœ‹å‡ºï¼ŒwebpackHotMiddlewareæ˜¯webpack-hot-middlewareä¸­é—´ä»¶æš´éœ²çš„æ–¹æ³•ï¼Œåœ¨è¯¥ä¸­é—´ä»¶æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªEventSourceå»ºç«‹å’Œå®¢æˆ·ç«¯çš„SSEï¼š</p>
<pre><code>//å¼€å¯EventStreamå®ç°æœåŠ¡ç«¯äº‹ä»¶æ¨é€(SSE)çš„â€˜é•¿è¿æ¥â€™
  var eventStream = createEventStream(opts.heartbeat);
</code></pre><p>webpack-hot-middlewareä¼šç›‘å¬webpackçš„invalidå’Œdoneäº‹ä»¶ï¼Œå½“æ£€æµ‹åˆ°invalidæ—¶ï¼Œå‘å®¢æˆ·ç«¯æ¨é€buidingäº‹ä»¶ï¼Œå½“æ£€æµ‹åˆ°doneæ—¶ï¼Œå‘å®¢æˆ·ç«¯æ¨é€builtäº‹ä»¶ä»¥åŠå˜æ›´æ¨¡å—ã€‚å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç¬¬ä¸€æ¬¡è¿æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šå‘å®¢æˆ·ç«¯æ¨é€syncäº‹ä»¶ï¼Œè¿›è¡ŒåŒæ­¥ã€‚</p>
<pre><code>//ç›‘å¬webpackç¼–è¯‘å®Œæˆå’Œç¼–è¯‘æ— æ•ˆäº‹ä»¶
  if (compiler.hooks) {
    compiler.hooks.invalid.tap(&quot;webpack-hot-middleware&quot;, onInvalid);
    compiler.hooks.done.tap(&quot;webpack-hot-middleware&quot;, onDone);
  } else {
    compiler.plugin(&quot;invalid&quot;, onInvalid);
    compiler.plugin(&quot;done&quot;, onDone);
  }
  function onInvalid() {
    latestStats = null;
    if (opts.log) opts.log(&quot;webpack building...&quot;);
    //ç¼–è¯‘æ— æ•ˆæ—¶å‘å®¢æˆ·ç«¯æ¨é€buildingäº‹ä»¶
    eventStream.publish({action: &quot;building&quot;}); 
  }
  function onDone(statsResult) {
    // Keep hold of latest stats so they can be propagated to new clients
    latestStats = statsResult;
    //ç¼–è¯‘å®Œæˆæ—¶å‘å®¢æˆ·ç«¯æ¨é€builtäº‹ä»¶ï¼Œä»¥åŠçŠ¶æ€ç»“æœ
    publishStats(&quot;built&quot;, latestStats, eventStream, opts.log);
  }
  var middleware = function(req, res, next) {
    if (!pathMatch(req.url, opts.path)) return next();
    eventStream.handler(req, res);
    //å‘é€åŒæ­¥äº‹ä»¶
    if (latestStats) {
      // Explicitly not passing in `log` fn as we don&#39;t want to log again on
      // the server
      publishStats(&quot;sync&quot;, latestStats, eventStream);
    }
  };
</code></pre><p>ä¸ºäº†ä¿æŒå’Œå®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒHMR Serverä¼šæ¯éš”10sé€šè¿‡SSEå‘å®¢æˆ·ç«¯å‘é€å¿ƒè·³ã€‚ </p>
<pre><code>//æ¯éš”heartbeat(é»˜è®¤10s)å‘å®¢æˆ·ç«¯æ¨é€ğŸ’“
  setInterval(function heartbeatTick() {
    everyClient(function(client) {
      client.write(&quot;data: \uD83D\uDC93\n\n&quot;);
    });
  }, heartbeat).unref();
</code></pre><p>è¿™ä¸ªåœ¨æµè§ˆå™¨ä¸­ä¹Ÿå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼š</p>
<p><img src="https://i.imgur.com/qe8zuJT.png" alt=""></p>
<h4 id="4-2-hmr-runtime">4.2 HMR Runtime</h4>
<p>HMR Runtimeæ˜¯webpackæ‰“åŒ…æ³¨å…¥åˆ°æµè§ˆå™¨çš„ä»£ç ï¼Œç”¨äºæ¥æ”¶HMR Serveræ¨é€çš„äº‹ä»¶å¹¶æ›´æ–°æ¨¡å—ï¼Œå®ƒæ˜¯é€šè¿‡æˆ‘ä»¬åœ¨webpack.config.jsé…ç½®æ–‡ä»¶çš„å…¥å£ä¸­é…ç½®å®ç°çš„ï¼š</p>
<pre><code>const path = require(&#39;path&#39;);
const webpack = require(&#39;webpack&#39;);
module.exports = {
  entry: [&#39;webpack-hot-middleware/client?noInfo=true&amp;reload=true&#39; , &#39;./src/index.js&#39;],
  ...
};
</code></pre><p>å®ƒçš„æºä»£ç åœ¨webpack-hot-middlewareçš„client.jsä¸­å®ç°ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p>
<pre><code>/*eslint-env browser*/
/*global __resourceQuery __webpack_public_path__*/

var options = {
  path: &quot;/__webpack_hmr&quot;, //Event Sourceçš„è·¯å¾„
  timeout: 20 * 1000, //è¶…æ—¶æ—¶é—´
  overlay: true,
  reload: false, //é»˜è®¤ä¸å¼ºåˆ·
  log: true,
  warn: true,
  name: &#39;&#39;,
  autoConnect: true, //è‡ªåŠ¨è¿æ¥
  overlayStyles: {},
  overlayWarnings: false,
  ansiColors: {}
};
if (__resourceQuery) {
  var querystring = require(&#39;querystring&#39;);
  var overrides = querystring.parse(__resourceQuery.slice(1));
  setOverrides(overrides);
}

if (typeof window === &#39;undefined&#39;) {
  // do nothing
} else if (typeof window.EventSource === &#39;undefined&#39;) {
  console.warn(
    &quot;webpack-hot-middleware&#39;s client requires EventSource to work. &quot; +
    &quot;You should include a polyfill if you want to support this browser: &quot; +
    &quot;https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events#Tools&quot;
  );
} else {
  if (options.autoConnect) {
    connect();
  }
}

/* istanbul ignore next */
function setOptionsAndConnect(overrides) {
  setOverrides(overrides);
  connect();
}

function setOverrides(overrides) {
  if (overrides.autoConnect) options.autoConnect = overrides.autoConnect == &#39;true&#39;;
  if (overrides.path) options.path = overrides.path;
  if (overrides.timeout) options.timeout = overrides.timeout;
  if (overrides.overlay) options.overlay = overrides.overlay !== &#39;false&#39;;
  if (overrides.reload) options.reload = overrides.reload !== &#39;false&#39;;
  if (overrides.noInfo &amp;&amp; overrides.noInfo !== &#39;false&#39;) {
    options.log = false;
  }
  if (overrides.name) {
    options.name = overrides.name;
  }
  if (overrides.quiet &amp;&amp; overrides.quiet !== &#39;false&#39;) {
    options.log = false;
    options.warn = false;
  }

  if (overrides.dynamicPublicPath) {
    options.path = __webpack_public_path__ + options.path;
  }

  if (overrides.ansiColors) options.ansiColors = JSON.parse(overrides.ansiColors);
  if (overrides.overlayStyles) options.overlayStyles = JSON.parse(overrides.overlayStyles);

  if (overrides.overlayWarnings) {
    options.overlayWarnings = overrides.overlayWarnings == &#39;true&#39;;
  }
}

function EventSourceWrapper() {
  var source;
  var lastActivity = new Date();
  var listeners = [];

  init();
  var timer = setInterval(function() {
    if ((new Date() - lastActivity) &gt; options.timeout) {
      handleDisconnect();
    }
  }, options.timeout / 2);

  function init() {
    source = new window.EventSource(options.path);
    source.onopen = handleOnline;
    source.onerror = handleDisconnect;
    source.onmessage = handleMessage;
  }

  function handleOnline() {
    if (options.log) console.log(&quot;[HMR] connected&quot;);
    lastActivity = new Date();
  }

  function handleMessage(event) {
    lastActivity = new Date();
    for (var i = 0; i &lt; listeners.length; i++) {
      listeners[i](event);
    }
  }

  function handleDisconnect() {
    clearInterval(timer);
    source.close();
    setTimeout(init, options.timeout);
  }

  return {
    addMessageListener: function(fn) {
      listeners.push(fn);
    }
  };
}

function getEventSourceWrapper() {
  if (!window.__whmEventSourceWrapper) {
    window.__whmEventSourceWrapper = {};
  }
  if (!window.__whmEventSourceWrapper[options.path]) {
    // cache the wrapper for other entries loaded on
    // the same page with the same options.path
    window.__whmEventSourceWrapper[options.path] = EventSourceWrapper();
  }
  return window.__whmEventSourceWrapper[options.path];
}

function connect() {
  getEventSourceWrapper().addMessageListener(handleMessage);

  function handleMessage(event) {
    if (event.data == &quot;\uD83D\uDC93&quot;) {
      return;
    }
    try {
      processMessage(JSON.parse(event.data));
    } catch (ex) {
      if (options.warn) {
        console.warn(&quot;Invalid HMR message: &quot; + event.data + &quot;\n&quot; + ex);
      }
    }
  }
}

// the reporter needs to be a singleton on the page
// in case the client is being used by multiple bundles
// we only want to report once.
// all the errors will go to all clients
var singletonKey = &#39;__webpack_hot_middleware_reporter__&#39;;
var reporter;
if (typeof window !== &#39;undefined&#39;) {
  if (!window[singletonKey]) {
    window[singletonKey] = createReporter();
  }
  reporter = window[singletonKey];
}

function createReporter() {
  var strip = require(&#39;strip-ansi&#39;);

  var overlay;
  if (typeof document !== &#39;undefined&#39; &amp;&amp; options.overlay) {
    overlay = require(&#39;./client-overlay&#39;)({
      ansiColors: options.ansiColors,
      overlayStyles: options.overlayStyles
    });
  }

  var styles = {
    errors: &quot;color: #ff0000;&quot;,
    warnings: &quot;color: #999933;&quot;
  };
  var previousProblems = null;
  function log(type, obj) {
    var newProblems = obj[type].map(function(msg) { return strip(msg); }).join(&#39;\n&#39;);
    if (previousProblems == newProblems) {
      return;
    } else {
      previousProblems = newProblems;
    }

    var style = styles[type];
    var name = obj.name ? &quot;&#39;&quot; + obj.name + &quot;&#39; &quot; : &quot;&quot;;
    var title = &quot;[HMR] bundle &quot; + name + &quot;has &quot; + obj[type].length + &quot; &quot; + type;
    // NOTE: console.warn or console.error will print the stack trace
    // which isn&#39;t helpful here, so using console.log to escape it.
    if (console.group &amp;&amp; console.groupEnd) {
      console.group(&quot;%c&quot; + title, style);
      console.log(&quot;%c&quot; + newProblems, style);
      console.groupEnd();
    } else {
      console.log(
        &quot;%c&quot; + title + &quot;\n\t%c&quot; + newProblems.replace(/\n/g, &quot;\n\t&quot;),
        style + &quot;font-weight: bold;&quot;,
        style + &quot;font-weight: normal;&quot;
      );
    }
  }

  return {
    cleanProblemsCache: function () {
      previousProblems = null;
    },
    problems: function(type, obj) {
      if (options.warn) {
        log(type, obj);
      }
      if (overlay) {
        if (options.overlayWarnings || type === &#39;errors&#39;) {
          overlay.showProblems(type, obj[type]);
          return false;
        }
        overlay.clear();
      }
      return true;
    },
    success: function() {
      if (overlay) overlay.clear();
    },
    useCustomOverlay: function(customOverlay) {
      overlay = customOverlay;
    }
  };
}

var processUpdate = require(&#39;./process-update&#39;);

var customHandler;
var subscribeAllHandler;
function processMessage(obj) {
  switch(obj.action) {
    case &quot;building&quot;:
      if (options.log) {
        console.log(
          &quot;[HMR] bundle &quot; + (obj.name ? &quot;&#39;&quot; + obj.name + &quot;&#39; &quot; : &quot;&quot;) +
          &quot;rebuilding&quot;
        );
      }
      break;
    case &quot;built&quot;:
      if (options.log) {
        console.log(
          &quot;[HMR] bundle &quot; + (obj.name ? &quot;&#39;&quot; + obj.name + &quot;&#39; &quot; : &quot;&quot;) +
          &quot;rebuilt in &quot; + obj.time + &quot;ms&quot;
        );
      }
      // fall through
    case &quot;sync&quot;:
      if (obj.name &amp;&amp; options.name &amp;&amp; obj.name !== options.name) {
        return;
      }
      var applyUpdate = true;
      if (obj.errors.length &gt; 0) {
        if (reporter) reporter.problems(&#39;errors&#39;, obj);
        applyUpdate = false;
      } else if (obj.warnings.length &gt; 0) {
        if (reporter) {
          var overlayShown = reporter.problems(&#39;warnings&#39;, obj);
          applyUpdate = overlayShown;
        }
      } else {
        if (reporter) {
          reporter.cleanProblemsCache();
          reporter.success();
        }
      }
      if (applyUpdate) {
        processUpdate(obj.hash, obj.modules, options);
      }
      break;
    default:
      if (customHandler) {
        customHandler(obj);
      }
  }

  if (subscribeAllHandler) {
    subscribeAllHandler(obj);
  }
}

if (module) {
  module.exports = {
    subscribeAll: function subscribeAll(handler) {
      subscribeAllHandler = handler;
    },
    subscribe: function subscribe(handler) {
      customHandler = handler;
    },
    useCustomOverlay: function useCustomOverlay(customOverlay) {
      if (reporter) reporter.useCustomOverlay(customOverlay);
    },
    setOptionsAndConnect: setOptionsAndConnect
  };
}
</code></pre><h5 id="4-2-1-">4.2.1 å»ºç«‹è¿æ¥</h5>
<p>å®¢æˆ·ç«¯ä»£ç åœ¨æµè§ˆå™¨ä¸­åŠ è½½åï¼Œé»˜è®¤ä¼šè‡ªåŠ¨å»ºç«‹ä¸HMR Serverçš„è¿æ¥ï¼š</p>
<pre><code>var options = {
  path: &quot;/__webpack_hmr&quot;, //Event Sourceçš„è·¯å¾„
  timeout: 20 * 1000, //è¶…æ—¶æ—¶é—´
  overlay: true,
  reload: false, //é»˜è®¤ä¸å¼ºåˆ·
  log: true,
  warn: true,
  name: &#39;&#39;,
  autoConnect: true, //è‡ªåŠ¨è¿æ¥
  overlayStyles: {},
  overlayWarnings: false,
  ansiColors: {}
};
if (__resourceQuery) {
  var querystring = require(&#39;querystring&#39;);
  var overrides = querystring.parse(__resourceQuery.slice(1));
  setOverrides(overrides);
}

if (typeof window === &#39;undefined&#39;) {
  // do nothing
} else if (typeof window.EventSource === &#39;undefined&#39;) {
  console.warn(
    &quot;webpack-hot-middleware&#39;s client requires EventSource to work. &quot; +
    &quot;You should include a polyfill if you want to support this browser: &quot; +
    &quot;https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events#Tools&quot;
  );
} else {
  if (options.autoConnect) {
    connect(); //è‡ªåŠ¨è¿æ¥
  }
}
</code></pre><h5 id="4-2-2-connect-">4.2.2 connectå‡½æ•°</h5>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹connectä»£ç çš„å®ç°ã€‚</p>
<pre><code>function connect() {
  getEventSourceWrapper().addMessageListener(handleMessage);

  function handleMessage(event) {
    if (event.data == &quot;\uD83D\uDC93&quot;) {
      return;
    }
    try {
      processMessage(JSON.parse(event.data));//å¤„ç†HMR æ¨é€çš„æ›´æ–°
    } catch (ex) {
      if (options.warn) {
        console.warn(&quot;Invalid HMR message: &quot; + event.data + &quot;\n&quot; + ex);
      }
    }
  }
}
</code></pre><p>å®ƒé¦–å…ˆé€šè¿‡Event Sourceæ¥ä¸HMR Serverå»ºç«‹è¿æ¥ï¼Œç„¶åç›‘å¬HMR Serveræ¨é€çš„äº‹ä»¶ã€‚ å¦‚æœæ”¶åˆ°çš„æ˜¯ğŸ’“ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚å¦åˆ™è°ƒç”¨processMessageå¤„ç†æ”¶åˆ°çš„äº‹ä»¶ã€‚</p>
<h5 id="4-2-3-eventsourcewrapper-">4.2.3 EventSourceWrapperå‡½æ•°</h5>
<p>HMR Runtimeä¼šé€šè¿‡lastActivityæ¥åˆ¤æ–­ä¸HMR Serveræ˜¯å¦è¿æ¥ã€‚ åˆ¤æ–­çš„é€»è¾‘æ˜¯ï¼ŒHMR Runtimeä¼šåœ¨æ¯æ¬¡æ”¶åˆ°SSEäº‹ä»¶çš„æ—¶å€™æ›´æ–°lastActivityä¸ºå½“å‰æ—¶é—´æˆ³ï¼Œå¹¶ä¸”ï¼ŒHMR Runtimeè‡ªå·±æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”10så»æ£€æŸ¥æœ€åä¸€æ¬¡æ”¶åˆ°æ¶ˆæ¯è‡³æ­¤æ—¶æ­¤åˆ»è¿‡å»çš„æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è®¾ç½®çš„è¶…æ—¶æ—¶é—´åˆ™æ–­å¼€è¿æ¥å¹¶è‡ªåŠ¨é‡æ–°å»ºç«‹è¿æ¥ã€‚</p>
<pre><code>  init();
  //æ¯éš”10så»æ£€æŸ¥æœ€åä¸€æ¬¡æ”¶åˆ°æ¶ˆæ¯è‡³æ­¤æ—¶æ­¤åˆ»è¿‡å»çš„æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è®¾ç½®çš„è¶…æ—¶æ—¶é—´åˆ™æ–­å¼€è¿æ¥
  var timer = setInterval(function() {
    if ((new Date() - lastActivity) &gt; options.timeout) {
      handleDisconnect();
    }
  }, options.timeout / 2);

  function init() {
    source = new window.EventSource(options.path);
    source.onopen = handleOnline;
    source.onerror = handleDisconnect;
    source.onmessage = handleMessage;
  }

  function handleOnline() {
    if (options.log) console.log(&quot;[HMR] connected&quot;);
    lastActivity = new Date();
  }

  function handleMessage(event) {
    lastActivity = new Date();//æ¯æ¬¡æ”¶åˆ°æ¶ˆæ¯ï¼Œæ›´æ–°æ—¶é—´æˆ³
    for (var i = 0; i &lt; listeners.length; i++) {
      listeners[i](event);
    }
  }

  function handleDisconnect() {
    clearInterval(timer);
    source.close();
    //è‡ªåŠ¨é‡æ–°å»ºç«‹è¿æ¥ã€‚
    setTimeout(init, options.timeout);
  }
</code></pre><h5 id="4-2-4-processmessage-">4.2.4 processMessageå‡½æ•°</h5>
<p>å‰é¢åœ¨è®²connetçš„æ—¶å€™ï¼Œè¯´åˆ°äº†åœ¨æ”¶åˆ°éğŸ’“æ•°æ®çš„æ—¶å€™ä¼šè°ƒç”¨processMessageå¤„ç†æ›´æ–°ï¼ŒprocessMessageä¼šæ ¹æ®SSEçš„ç±»å‹åŒºåˆ«å¯¹å¾…ï¼š</p>
<ul>
<li>å½“æ”¶åˆ°çš„SSEæ˜¯buidingçš„æ—¶å€™ï¼Œæ‰“å°æ—¥å¿—ã€‚</li><li>å½“æ”¶åˆ°çš„SSEæ˜¯builtçš„æ—¶å€™æ‰“å°æ—¥å¿—å¹¶åŒæ­¥ä»£ç (è°ƒç”¨processUpdateæ›´æ–°æ¨¡å—)ã€‚</li><li><p>å½“æ”¶åˆ°çš„SSEæ˜¯syncçš„æ—¶å€™åŒæ­¥ä»£ç (è°ƒç”¨processUpdateæ›´æ–°æ¨¡å—)ã€‚</p>
<p>  function processMessage(obj) {</p>
<pre><code>switch(obj.action) {
  case &quot;building&quot;: //æ„å»ºæ— æ•ˆï¼Œå¯¹åº”HMR Serverä¸­çš„invalid
    if (options.log) {
      console.log(
        &quot;[HMR] bundle &quot; + (obj.name ? &quot;&#39;&quot; + obj.name + &quot;&#39; &quot; : &quot;&quot;) +
        &quot;rebuilding&quot;
      );
    }
    break;
  case &quot;built&quot;: //æ„å»ºå®Œæˆï¼Œå¯¹åº”HMR Serverä¸­çš„done
    if (options.log) {
      console.log(
        &quot;[HMR] bundle &quot; + (obj.name ? &quot;&#39;&quot; + obj.name + &quot;&#39; &quot; : &quot;&quot;) +
        &quot;rebuilt in &quot; + obj.time + &quot;ms&quot;
      );
    }
    // fall through
  case &quot;sync&quot;:
    if (obj.name &amp;&amp; options.name &amp;&amp; obj.name !== options.name) {
      return;
    }
    var applyUpdate = true;
    if (obj.errors.length &gt; 0) {
      if (reporter) reporter.problems(&#39;errors&#39;, obj);
      applyUpdate = false;
    } else if (obj.warnings.length &gt; 0) {
      if (reporter) {
        var overlayShown = reporter.problems(&#39;warnings&#39;, obj);
        applyUpdate = overlayShown;
      }
    } else {
      if (reporter) {
        reporter.cleanProblemsCache();
        reporter.success();
      }
    }
    if (applyUpdate) {
      processUpdate(obj.hash, obj.modules, options); //è°ƒç”¨processUpdateæ›´æ–°æ¨¡å—
    }
    break;
  default:
    if (customHandler) {
      customHandler(obj);
    }
}

if (subscribeAllHandler) {
  subscribeAllHandler(obj);
}
</code></pre><p>  }</p>
</li></ul>
<h5 id="4-2-5-processupdate-">4.2.5 processUpdateå‡½æ•°</h5>
<p>å‰é¢è¯´åˆ°äº†ï¼Œæœ€ç»ˆçš„æ›´æ–°æ¨¡å—æ˜¯é€šè¿‡processUpdateå‡½æ•°æ¥å®Œæˆçš„ï¼ŒprocessUpdateå®šä¹‰åœ¨webpack-hot-middlewareçš„process-update.jsæ–‡ä»¶ä¸­ã€‚ è¯¥å‡½æ•°çš„æ ¸å¿ƒæ˜¯è°ƒç”¨webpac.hotä¸Šæš´éœ²çš„checkå’Œapplyæ–¹æ³•ï¼Œæ£€æŸ¥å¹¶æ›´æ–°æ¨¡å—ï¼š</p>
<pre><code>function check() {
    var cb = function(err, updatedModules) {
      if (err) return handleError(err);

      if(!updatedModules) {
        if (options.warn) {
          console.warn(&quot;[HMR] Cannot find update (Full reload needed)&quot;);
          console.warn(&quot;[HMR] (Probably because of restarting the server)&quot;);
        }
        performReload();
        return null;
      }

      var applyCallback = function(applyErr, renewedModules) {
        if (applyErr) return handleError(applyErr);

        if (!upToDate()) check();

        logUpdates(updatedModules, renewedModules);
      };

      var applyResult = module.hot.apply(applyOptions, applyCallback);//åº”ç”¨æ›´æ–°
      // webpack 2 promise
      if (applyResult &amp;&amp; applyResult.then) {
        // HotModuleReplacement.runtime.js refers to the result as `outdatedModules`
        applyResult.then(function(outdatedModules) {
          applyCallback(null, outdatedModules);
        });
        applyResult.catch(applyCallback);
      }

    };

    var result = module.hot.check(false, cb);//æ£€æŸ¥æ¨¡å—æ›´æ–°
    // webpack 2 promise
    if (result &amp;&amp; result.then) {
        result.then(function(updatedModules) {
            cb(null, updatedModules);
        });
        result.catch(cb);
    }
}
</code></pre><blockquote>
<p>æ³¨æ„ï¼šç”±äºæˆ‘ä»¬å·²ç»é€šè¿‡ HotModuleReplacementPlugin å¯ç”¨äº†æ¨¡å—çƒ­æ›¿æ¢(Hot Module Replacement)ï¼Œæ‰€ä»¥å®ƒçš„check,applyç­‰æ¥å£ä¼šè¢«æš´éœ²åœ¨ module.hot å±æ€§ä¸Šã€‚</p>
</blockquote>
<p>è‡³æ­¤ï¼Œåœ¨webpack-hot-middlewareçš„æ”¯æŒä¸‹ï¼ŒHMRçš„å®ç°åŸç†å°±è®²è¿°å®Œäº†ã€‚</p>
<h3 id="-webpack-dev-server-hmr-">äº”. webpack-dev-serverçš„HMRå®ç°åˆ†æ</h3>
<p>ç¬¬å››èŠ‚æˆ‘ä»¬é€šè¿‡æºç è®²è¿°äº†webpack-hot-middlewareå®ç°HMRçš„åŸç†ï¼Œ webpack-dev-serverå®ç°çš„HMRåŸç†å’Œwebpack-hot-middlewareå¯ä»¥è¯´æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯webpack-dev-serverä¸­çš„é•¿è¿æ¥æ˜¯ç”¨websocketå®ç°çš„ã€‚</p>
<p>HMRåªæ˜¯webpack-dev-serverçš„å…¶ä¸­ä¸€å°éƒ¨åˆ†åŠŸèƒ½ï¼Œwebpack-dev-serverè¿˜æ”¯æŒå¾ˆå¤šå¼ºå¤§çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸ä¸“é—¨çœ‹ä»–çš„æºç å®ç°äº†ã€‚</p>
<h3 id="-webpack-hot-middleware-webpack-dev-middleware-webpack-dev-server-">å…­. webpack-hot-middleware ä¸ webpack-dev-middleware ä¸  webpack-dev-serveræœ‰ä»€ä¹ˆè”ç³»å’ŒåŒºåˆ«ï¼Ÿ</h3>
<p>é‚£ä¹ˆè®²äº†è¿™ä¹ˆå¤šï¼Œä½ æ˜¯ä¸æ˜¯å¯¹webpack-hot-middleware ä¸ webpack-dev-middleware ä¸  webpack-dev-serveræœ‰ç‚¹å‚»å‚»åˆ†ä¸æ¸…äº†å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä»–ä»¬çš„åŒºåˆ«å’Œè”ç³»ã€‚</p>
<ol>
<li>webpack-dev-serverå¯å•ç‹¬(å®é™…ä¸Šwebpack-dev-serverå†…éƒ¨ä¾èµ–äº†webpack-dev-middlewareåŒ…)å®ç°HMRï¼Œwebpack-hot-middleware éœ€è¦ä¸ webpack-dev-middlewareç»“åˆæ‰èƒ½å®ç°ã€‚</li><li>webpack-dev-serverå®ç°HMRä½¿ç”¨çš„æ˜¯websocket, webpack-hot-middlewareä½¿ç”¨çš„æ˜¯Event Sourceã€‚</li><li>webpack-dev-serverä¾èµ–äºwebpack-dev-middlewareåŒ…ã€‚</li><li>webpack-dev-serverçš„åŠŸèƒ½è¿œæ¯”webpack-hot-middlewareå¼ºå¤§ã€‚</li></ol>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
