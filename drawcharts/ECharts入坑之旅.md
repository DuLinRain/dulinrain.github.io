##ECharts入坑之旅
###一、概述
ECharts是百度开源的一款图表类JS库，可以提供丰富的绘图功能，但是在使用ECharts开发完一个项目之后，发现ECharts有很多不尽如人意的地方，甚至可以说是存在很多很多坑！！下面一一列举一下。
###二、坑1 —— 自定义y轴单位
在进行图表绘制时，y轴数值可能会达到很大（百万），这时，如果不进行处理，y轴的数据可能会显示成如下样子：

![](http://i.imgur.com/5Rzo5gZ.jpg)

如果数值再大一点，可能还会导致溢出。如下：

![](http://i.imgur.com/ohVd3JA.png)

这个溢出问题其实是ECahrts的另外一个坑，稍后再聊。数值较大时直接显示出来非常不易读，常常需要对数值做一定的处理，带上一定的单位，比如“万”，“千”之类的，遗憾的是ECharts并不能自动做到。
#####解决方法
一种可能的解决办法是通过ECharts的yAxis属性进行设置，其设置方法大概就是将数据除以10000,并显示一个单位“万”。比如：

![](http://i.imgur.com/zLWz641.jpg)

使用后的效果如图：

![](http://i.imgur.com/K3YcAyE.jpg)

但是，什么时候设置带“万”的y轴呢？

1. 当曲线只有一条时，可以检测这条曲线的数据，如果有任何一个数据点的值超过10000，那么坐标轴就需要设置为“万”。
2. 当曲线有N条时，那么就得需要检测这N条曲线的数据了，如果N条曲线里面的任意一条曲线的任意一个数据点的值超过10000，那么坐标轴就需要设置为“万”。
实际上这个工作量已经很大了，如果到此能解决自定义y轴的所有问题那也还好。事实上，即使这样仍然还存在问题。

在上图中，存在5条曲线，实际上只有橙色的曲线存在过万的数值，而在图中，我们是可以通过点击对应的legend取消某一条曲线的显示的。如下：

![](http://i.imgur.com/7uLOWei.jpg)

可以看到，取消这条曲线显示之后，事实上已经没有任何曲线的任何数据值大于10000了,但是，y轴的坐标仍然为带“万”的。也就是说，ECharts做不到自动重新计算，它使用的仍然是下面这个配置：

![](http://i.imgur.com/zLWz641.jpg)

#####解决方法
一种可能的解决方法是，监听legend的click事件，然后手动的重新计算所有剩余曲线中是否存在超过10000的值，如果存在，则根据这个结果来重新定义yAxis,重新绘制。具体的方法如下：

![](http://i.imgur.com/AkhQUJv.jpg)

实际上，这意味着可能需要再次计算N-1条曲线是否存在任意一个超过10000的数据值。这又是一个较大的计算量。

如果处理好了，结果可能长下面这个样子：

![](http://i.imgur.com/w7EULbd.jpg)

这个问题在堆积图场合更麻烦，因为堆积图是画所有曲线堆积起来，是否超过10000也需要将它们加起来判断，这样当有曲线被取消显示之后，需要把剩下的曲线加起来判断是否有任意曲线有超过10000的某个点。如图：

#####堆积后过万

![](http://i.imgur.com/RNo2TSK.jpg)

#####取消显示某条曲线，堆积后不再过万

![](http://i.imgur.com/cJ46vh9.jpg)

###三、坑2 —— legend全部取消后，坐标轴会压缩

前面说了，可以通过点击legend来取消某条曲线的显示，但是有时候莫名其妙的会出现，在legend全部消后，坐标轴压缩了。如图：

#####全部都显示时：

![](http://i.imgur.com/QM1mmV7.jpg)


#####全部都不显示时（正常效果）：

![](http://i.imgur.com/lyvc8Pm.jpg)

#####全部都不显示时（异常效果）：

![](http://i.imgur.com/ZaykUQk.jpg)

由于这个问题有时候出现，有时候又不出现，所以也没搞懂这个问题的根源，所以只能采用一种笨的解决办法。

#####解决方法

解决方法仍然是监听legend选中事件，当legend被全部选中时，直接把整个横轴、纵轴隐藏掉。如下：

![](http://i.imgur.com/nApLQQm.jpg)

效果类似下面这个样子：

![](http://i.imgur.com/uxICjOK.jpg)

###四、坑3 —— title和subtitle只支持纯文本，不支持html
ECharts图表的title和subtitle只能使用纯文本，不能使用html。这样就导致在设置某些带有样式的title和subtitle时无法使用EChart提供的这两个属性做到。如下两种效果用ECharts的title和subtitle属性都是无法做到的。

![](http://i.imgur.com/zG0WB2v.jpg)
![](http://i.imgur.com/q2SNM8S.jpg)

#####解决方法
一种可能的解决办法就是自己写一个DOM放置title和subtitle以及一些个性化的信息。如下：

![](http://i.imgur.com/FabCCaS.jpg)

这样实际上就意味着title和subtitle实际上并不是和图表一个整体，虽然这并没有什么问题，但是从常识来讲图表的各个部分组合在一起还是比较好的。

###五、坑4 —— legend过多时，不会自适应
ECharts在绘制图表时，如果legend比较多，或者legend的名字比较长时，ECharts是不会自动调整图表与legend的位置来实现自适应的。这样导致的效果如下：

![](http://i.imgur.com/ZTf9PQ2.jpg)
![](http://i.imgur.com/TVkUkaj.jpg)
这种现象在图片比较小的时候特别容易出现。
#####解决办法
一种可能的解决办法是通过手动的计算legend字符串的长度，然后根据最长的legend长度和legend个数来决定一行放多少个legend，从而调整图片绘制网格和legend之间的距离，从而是的有足够空间放置legend。

但是，通过计算legend字符串长度来调整是很不精确的，因为中文字符和英文字符虽然长度一样，但是他们在图上的宽度并不一样，另外“.”号和英文字母所占据的宽度也不一样。所以更好一点的办法是根据字符串的不同类型来合理计算它占用的总宽度。

比如中文宽度为2，字母宽度为1，“.”号等字符宽度为0.5。这样可以稍微精确的调整，避免出现legend挤到绘图grid里面去。如下：

![](http://i.imgur.com/FUDIM44.jpg)

这种办法可以在一定程度上解决问题，但是当绘图区域比较小，而legend又很多很多时，甚至仅仅legend就可以铺满整个绘图区域时，这种方法也解决不了问题。
#####解决方法
这时，另外一种解决办法是，当绘图区域比较小时，只显示前M（比如M=10）条,剩余的通过大图详情去完整显示。同时，对legend字符宽度做一定截取，以省略号替代。这样得到的效果大概如下：

![](http://i.imgur.com/4NfCs4y.jpg)

大图详情如下：

![](http://i.imgur.com/y0Msbo3.jpg)

这里需要注意的是，当对legend进行截取时，可能导致截取后的legend是一样的。比如：

	ABCDE12345
	ABCDE23123

截取前5位的话，结果都是ABCDE，这样导致只会画出一条曲线，所以可以考虑在后面附加上不同个数的“.”号以做区分。

以上只能做到尽量自适应，要想更进一步的自适应，还需要根据窗口的大小来调整legend和绘图网格的范围，这样才能在缩放页面情况下仍保持较好的适应,但这个工作量就巨大了。要从根本上解决自适应问题，还得从ECharts源码上动手脚，这个就有点麻烦了。。。。从github上的评论来看，百度目前并没有修复这个问题的计划。

###六、坑5 —— 条形图label过长时不会自动缩放
坑4中所说的问题在绘制条形图时，左侧的label过长时也会出现问题，ECharts也无法自适应。如下：

![](http://i.imgur.com/g5k0J2X.jpg)

其解决方法类似，需要根据最长label来调整绘图网格距离左边的距离，以容纳label。但是当lebel无限长时，总不能全部显示出来吧，所以更好的办法还是要截取一定的长度来使用。如下：

![](http://i.imgur.com/nKqpCQc.jpg)
![](http://i.imgur.com/2J7WNkL.jpg)

这样得到的效果如下：

![](http://i.imgur.com/wVQPwfd.jpg)

###七、坑6 —— 无自带的百分比图，且百分比图在取消部分legend后不会自动重新计算百分比
在绘图的时候，有时候需要绘制百分比的图，如下：

![](http://i.imgur.com/uHqDxKJ.jpg)

ECharts没有自带的该功能。
#####解决办法
一种可能的解决办法是自己计算各条曲线的百分比值，然后以“堆积图”的形式绘制百分比图，然后自定义y轴单位（加个%号）。

百分比图存在的一个问题是，当取消显示某条曲线后，需要重新计算剩余曲线各自的百分比，然后重新绘制图表。当线条较多时，计算量也挺大的。

###八、坑7 —— 双向柱图不支持自定义阈值
在绘图的时候，有时候需要绘制双向柱图，如下是默认的双向柱图(阈值为0)：

![](http://i.imgur.com/L4B6Uyz.png)

因为阈值为0，而所有数值都大于0,所以看起来和条形图没啥区别。

ECharts本身只提供了以0位阈值的双向柱图，对于自定义阈值则不自动支持。
#####解决方法
一种可能的解决方法是，自己定义一个阈值，然后将实际数据整体减去该阈值，然后根据正负来画双向柱图。由于ECharts阈值只能是0，导致坐标轴上显示的也是以0分割的双向柱图，所以，自定义阈值时为了掩盖这一特点，需要将坐标轴隐藏起来。具体的值可以通过图上的标注显示。如下：

![](http://i.imgur.com/1VWRfI9.jpg)

如下是自定义阈值200时的双向柱图：

![](http://i.imgur.com/hKtXtwN.jpg)

所有小于200的都在左侧，大于200的都在右侧。